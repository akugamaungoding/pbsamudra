<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Strip - Makrab MI</title>

  <!-- BOOTSTRAP -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- POPPINS FONT -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      min-height: 100vh;
      color: #1a237e;
    }

    .header-section {
      background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
      color: white;
      padding: 2.5rem 1rem;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 20px rgba(13, 71, 161, 0.2);
      margin-bottom: 2rem;
      text-align: center;
    }

    .header-section h1 {
      font-weight: 800;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .header-section p {
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
      opacity: 0.95;
    }

    #video {
      width: 100%;
      max-width: 420px;
      border-radius: 15px;
      border: 4px solid #1976d2;
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.3);
      background: #0d47a1;

      /* Preview kamera kotak (1:1) */
      aspect-ratio: 1 / 1;
      object-fit: cover;

      /* FLIP PREVIEW (mirror selfie) */
      transform: scaleX(-1);
    }

    #countdown {
      font-size: 3rem;
      font-weight: 800;
      color: #0d47a1;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 0.5s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .camera-section,
    .upload-section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem 1.8rem;
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.15);
      height: 100%;
    }

    .camera-label {
      font-weight: 700;
      color: #0d47a1;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
      border: none;
      font-weight: 700;
      padding: 0.7rem 1.3rem;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
      background: linear-gradient(135deg, #0d47a1 0%, #051f3d 100%);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-success {
      background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
      border: none;
      font-weight: 700;
      padding: 0.7rem 1.3rem;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 160, 71, 0.4);
      background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
    }

    .btn-outline-danger {
      border-radius: 10px;
      font-weight: 600;
    }

    .thumb {
      width: 100%;
      max-width: 130px;
      border-radius: 12px;
      border: 3px solid #1976d2;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      background: #e3f2fd;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
    }

    .thumb:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 18px rgba(25, 118, 210, 0.3);
    }

    .preview-section {
      background: white;
      border-radius: 15px;
      padding: 1.8rem;
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.15);
    }

    .preview-label {
      font-weight: 700;
      color: #0d47a1;
      margin-bottom: 1.2rem;
      font-size: 1.1rem;
    }

    .slot-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 0.8rem 1rem;
      border-radius: 10px;
      text-align: center;
      margin-top: 1rem;
      font-weight: 600;
      color: #0d47a1;
      border-left: 4px solid #1976d2;
    }

    .instruction-text {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      padding: 1rem;
      border-radius: 10px;
      color: #e65100;
      font-weight: 600;
      margin-top: 1.2rem;
      border-left: 4px solid #ff9800;
      font-size: 0.9rem;
    }

    .step-list {
      list-style: none;
      padding: 0;
      margin: 1rem 0 0;
    }

    .step-list li {
      padding: 0.35rem 0;
      padding-left: 2rem;
      position: relative;
      font-weight: 500;
      color: #1a237e;
      font-size: 0.92rem;
    }

    .step-list li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #1976d2;
      font-weight: 800;
      font-size: 1.1rem;
    }

    .mode-card {
      background: white;
      border-radius: 15px;
      padding: 1rem 1.3rem;
      box-shadow: 0 6px 18px rgba(25, 118, 210, 0.18);
      margin-bottom: 1.5rem;
    }

    .mode-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 0.3rem;
      color: #0d47a1;
    }

    .mode-desc {
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }
  </style>
</head>
<body>

<div class="header-section">
  <h1>üì∏ Photo Strip Booth</h1>
  <p>SAMUDRA - MALAM KEAKRABAN<br>MANAJEMEN INFORMATIKA 2025</p>
</div>

<div class="container py-3">

  <!-- PILIH OPSI -->
  <div class="mode-card">
    <div class="row align-items-center g-2">
      <div class="col-md-7">
        <div class="mode-title">Pilih Cara Mengisi 3 Foto</div>
        <div class="mode-desc">
          <b>Opsi 1:</b> Upload 3 foto dari galeri.<br>
          <b>Opsi 2:</b> Ambil foto langsung di booth (1x klik = 3x foto dengan countdown).
        </div>
      </div>
      <div class="col-md-5 text-md-end text-center">
        <div class="btn-group" role="group" aria-label="Opsi pengambilan foto">
          <input type="radio" class="btn-check" name="mode" id="modeUpload" autocomplete="off" checked>
          <label class="btn btn-outline-primary" for="modeUpload">Opsi 1: Upload</label>

          <input type="radio" class="btn-check" name="mode" id="modeCamera" autocomplete="off">
          <label class="btn btn-outline-primary" for="modeCamera">Opsi 2: Kamera</label>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 justify-content-center">
    <!-- KOLOM KIRI: UPLOAD / KAMERA -->
    <div class="col-lg-6 col-xl-5">
      <!-- UPLOAD SECTION (OPSI 1) -->
      <div id="uploadSection" class="upload-section">
        <div class="camera-label">üñºÔ∏è Opsi 1: Upload 3 Foto</div>
        <p class="mb-2" style="font-size:0.9rem;">
          Pilih tepat <b>3 foto</b> dari galeri kamu. Sistem akan otomatis memotong foto menjadi kotak (1:1).
        </p>
        <input type="file" id="fileInput" accept="image/*" multiple class="form-control mb-3">
        <div class="instruction-text">
          <b>Langkah:</b>
          <ul class="step-list">
            <li>Tap tombol "Pilih File", lalu pilih 3 foto sekaligus.</li>
            <li>Tunggu preview 3 foto muncul di sebelah kanan.</li>
            <li>Kalau salah, tekan "Ulangi 3 Foto" lalu pilih ulang.</li>
          </ul>
        </div>
      </div>

      <!-- CAMERA SECTION (OPSI 2) -->
      <div id="cameraSection" class="camera-section d-none">
        <div class="camera-label">üì∑ Opsi 2: Ambil 3 Foto Sekaligus</div>
        <video id="video" autoplay playsinline class="mb-2"></video>
        <div id="countdown"></div>
        <div class="d-grid gap-2 mt-3">
          <button id="btnCapture" class="btn btn-primary">
            Ambil 3 Foto (Auto 3√ó Countdown)
          </button>
          <button id="btnReset" class="btn btn-outline-danger btn-sm">
            Ulangi 3 Foto
          </button>
        </div>
        <div class="instruction-text">
          <b>Langkah:</b>
          <ul class="step-list">
            <li>Posisikan wajah di tengah kotak kamera.</li>
            <li>Tekan "Ambil 3 Foto": akan ada 3x countdown (3 detik/foto).</li>
            <li>Foto akan otomatis tersimpan ke 3 slot di sebelah kanan.</li>
            <li>Kalau kurang cocok, tekan "Ulangi 3 Foto" lalu ambil lagi.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- PREVIEW 3 FOTO & DOWNLOAD -->
    <div class="col-lg-6 col-xl-5">
      <div class="preview-section">
        <div class="preview-label">Foto Anda (3 Slot)</div>
        <div class="d-flex gap-3 justify-content-center mb-2">
          <img id="thumb0" class="thumb" alt="Slot Foto 1">
          <img id="thumb1" class="thumb" alt="Slot Foto 2">
          <img id="thumb2" class="thumb" alt="Slot Foto 3">
        </div>
        <div class="slot-info">
          Foto tersimpan: <span id="slotCount" style="font-size:1.2rem; color:#1976d2;">0</span><span style="font-size:1.2rem;">/3</span>
        </div>

        <div class="mt-3 text-center">
          <button id="btnDownload" class="btn btn-success" disabled>
            Download Photo Strip Anda
          </button>
        </div>

        <ul class="step-list mt-3">
          <li>Isi 3 slot foto (upload atau kamera).</li>
          <li>Pastikan semua foto sudah muncul di preview.</li>
          <li>Tekan "Download Photo Strip Anda".</li>
          <li>File PNG akan tersimpan di perangkat kamu.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Canvas tersembunyi -->
<canvas id="hiddenShot" style="display:none;"></canvas>
<canvas id="finalCanvas" style="display:none;"></canvas>

<script>
  const modeUploadRadio = document.getElementById('modeUpload');
  const modeCameraRadio = document.getElementById('modeCamera');
  const uploadSection   = document.getElementById('uploadSection');
  const cameraSection   = document.getElementById('cameraSection');

  const video       = document.getElementById('video');
  const countdownEl = document.getElementById('countdown');
  const btnCapture  = document.getElementById('btnCapture');
  const btnReset    = document.getElementById('btnReset');
  const btnDownload = document.getElementById('btnDownload');
  const slotCountEl = document.getElementById('slotCount');
  const fileInput   = document.getElementById('fileInput');

  const thumbs = [
    document.getElementById('thumb0'),
    document.getElementById('thumb1'),
    document.getElementById('thumb2')
  ];

  const hiddenShot = document.getElementById('hiddenShot');
  const hiddenCtx  = hiddenShot.getContext('2d');
  const finalCanvas = document.getElementById('finalCanvas');
  const finalCtx    = finalCanvas.getContext('2d');

  const photos = [];       // simpan 3 Image (hasil crop square)
  let currentMode = 'upload';
  let isCapturing = false;
  let cameraStream = null;

  // ========== MODE SWITCH ==========
  modeUploadRadio.addEventListener('change', () => {
    if (modeUploadRadio.checked) {
      currentMode = 'upload';
      uploadSection.classList.remove('d-none');
      cameraSection.classList.add('d-none');
      stopCamera();
      clearPhotos();
    }
  });

  modeCameraRadio.addEventListener('change', () => {
    if (modeCameraRadio.checked) {
      currentMode = 'camera';
      uploadSection.classList.add('d-none');
      cameraSection.classList.remove('d-none');
      startCamera();
      clearPhotos();
    }
  });

  // ========== CAMERA HANDLING ==========
  async function startCamera() {
    if (cameraStream) return; // sudah jalan
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = cameraStream;
    } catch (err) {
      alert('Gagal membuka kamera: ' + err.message + '\n\nPastikan:\n- Browser diizinkan akses kamera\n- Dibuka lewat https atau http://localhost, bukan file://');
    }
  }

  function stopCamera() {
    if (cameraStream) {
      cameraStream.getTracks().forEach(t => t.stop());
      cameraStream = null;
      video.srcObject = null;
    }
  }

  // ========== HELPERS ==========
  function clearPhotos() {
    photos.length = 0;
    updateThumbs();
    btnDownload.disabled = true;
  }

  function updateThumbs() {
    slotCountEl.textContent = photos.length;
    thumbs.forEach((thumb, i) => {
      if (photos[i]) {
        thumb.src = photos[i].src;
      } else {
        thumb.src = '';
      }
    });
  }

  function doCountdown(seconds) {
    return new Promise(resolve => {
      let count = seconds;
      countdownEl.textContent = count;
      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownEl.textContent = count;
        } else {
          clearInterval(interval);
          countdownEl.textContent = '';
          resolve();
        }
      }, 1000);
    });
  }

  function cropToSquareAndReturnImage(rawImage) {
    return new Promise(resolve => {
      const vw = rawImage.naturalWidth;
      const vh = rawImage.naturalHeight;

      const size = 440;
      hiddenShot.width = size;
      hiddenShot.height = size;

      const videoAspect = vw / vh;
      let sx, sy, sSize;

      if (videoAspect > 1) {
        // lebih lebar
        sSize = vh;
        sx = (vw - sSize) / 2;
        sy = 0;
      } else {
        // lebih tinggi
        sSize = vw;
        sx = 0;
        sy = (vh - sSize) / 2;
      }

      hiddenCtx.save();
      // untuk upload, tidak perlu mirror ‚Üí pakai scale(1,1)
      hiddenCtx.setTransform(1, 0, 0, 1, 0, 0);
      hiddenCtx.clearRect(0, 0, size, size);
      hiddenCtx.drawImage(rawImage, sx, sy, sSize, sSize, 0, 0, size, size);
      hiddenCtx.restore();

      const img = new Image();
      img.onload = () => resolve(img);
      img.src = hiddenShot.toDataURL('image/png');
    });
  }

  // ========== OPSI 1: UPLOAD ==========
  fileInput.addEventListener('change', async (e) => {
    if (currentMode !== 'upload') return;

    const files = Array.from(e.target.files || []);
    if (files.length === 0) {
      clearPhotos();
      return;
    }

    if (files.length !== 3) {
      alert('Silakan pilih tepat 3 foto sekaligus.');
      // tetap lanjut tapi ambil maksimal 3 pertama
    }

    clearPhotos();

    const selectedFiles = files.slice(0, 3);

    for (const file of selectedFiles) {
      if (!file.type.startsWith('image/')) continue;

      const dataURL = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const rawImage = await new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = dataURL;
      });

      const squareImage = await cropToSquareAndReturnImage(rawImage);
      photos.push(squareImage);
      updateThumbs();
    }

    if (photos.length === 3) {
      btnDownload.disabled = false;
    } else {
      btnDownload.disabled = true;
    }
  });

  // ========== OPSI 2: KAMERA ==========
  btnCapture.addEventListener('click', async () => {
    if (currentMode !== 'camera') {
      alert('Pilih "Opsi 2: Kamera" terlebih dahulu.');
      return;
    }
    if (!cameraStream) {
      await startCamera();
      if (!cameraStream) return;
    }
    if (isCapturing) return;

    isCapturing = true;
    btnCapture.disabled = true;
    btnDownload.disabled = true;
    clearPhotos();

    // ambil 3 foto dengan 3x countdown
    for (let i = 0; i < 3; i++) {
      await doCountdown(3);
      const success = await takePhotoOnce();
      if (!success) {
        break;
      }
    }

    isCapturing = false;
    btnCapture.disabled = false;

    if (photos.length === 3) {
      btnDownload.disabled = true; // tetap manual enable di bawah
      btnDownload.disabled = false;
    } else {
      btnDownload.disabled = true;
    }
  });

  btnReset.addEventListener('click', () => {
    clearPhotos();
  });

  async function takePhotoOnce() {
    const size = 440;
    hiddenShot.width = size;
    hiddenShot.height = size;

    const vw = video.videoWidth;
    const vh = video.videoHeight;

    if (!vw || !vh) {
      alert('Video belum siap. Coba lagi sebentar lagi.');
      return false;
    }

    const videoAspect = vw / vh;
    let sx, sy, sSize;

    if (videoAspect > 1) {
      sSize = vh;
      sx = (vw - sSize) / 2;
      sy = 0;
    } else {
      sSize = vw;
      sx = 0;
      sy = (vh - sSize) / 2;
    }

    hiddenCtx.save();
    // mirror selfie di hasil foto
    hiddenCtx.translate(size, 0);
    hiddenCtx.scale(-1, 1);
    hiddenCtx.drawImage(video, sx, sy, sSize, sSize, 0, 0, size, size);
    hiddenCtx.restore();

    const img = new Image();
    await new Promise(resolve => {
      img.onload = resolve;
      img.src = hiddenShot.toDataURL('image/png');
    });

    photos.push(img);
    updateThumbs();
    return true;
  }

  // ========== TEMPLATE DAN DOWNLOAD ==========
  const templateImg = new Image();
  templateImg.crossOrigin = 'anonymous';
  templateImg.src = 'template.png'; // TARUH FILE INI DI FOLDER YANG SAMA
  let templateLoaded = false;

  templateImg.onload = () => {
    templateLoaded = true;
  };

  btnDownload.addEventListener('click', () => {
    if (!templateLoaded) {
      alert('Template belum selesai di-load. Coba lagi sebentar.');
      return;
    }
    if (photos.length < 3) {
      alert('Foto belum 3. Isi semua slot dulu.');
      return;
    }

    finalCanvas.width = templateImg.width;
    finalCanvas.height = templateImg.height;

    finalCtx.clearRect(0, 0, finalCanvas.width, finalCanvas.height);

    // posisi slot (sesuaikan dengan ukuran template)
    const slots = [
      { x: 30,  y: 40,   w: 440, h: 440 },
      { x: 30,  y: 520,  w: 440, h: 440 },
      { x: 30,  y: 1000, w: 440, h: 440 }
    ];

    photos.forEach((img, i) => {
      const s = slots[i];
      finalCtx.drawImage(img, s.x, s.y, s.w, s.h);
    });

    finalCtx.drawImage(templateImg, 0, 0);

    let dataURL;
    try {
      dataURL = finalCanvas.toDataURL('image/png');
    } catch (err) {
      alert(
        'Gagal membuat file image: canvas ter-taint (CORS).\n' +
        'Pastikan `template.png` berada di folder yang sama dan halaman dibuka lewat HTTP server.\n' +
        'Misal: `python -m http.server`.\n\nDetail error: ' + err.message
      );
      return;
    }

    const a = document.createElement('a');
    a.href = dataURL;
    a.download = 'photo-strip-makrab-mi-samudra.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  });

  // default: mulai di mode upload, kamera belum dinyalakan
</script>

</body>
</html>
